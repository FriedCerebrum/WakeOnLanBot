# Диагностика проблем с контейнером

## Проблема
Контейнер стартует, но логи пусты и происходят постоянные рестарты.

## Добавленная диагностика

### 1. Wrapper скрипт (diagnostic_wrapper.sh)
- Показывает все переменные окружения перед запуском
- Проверяет файловую систему контейнера
- Проверяет доступность бинарника

### 2. Максимально ранняя диагностика в main.rs
- `println!` вместо логов (работает без инициализации логгера)
- Пошаговая проверка каждого этапа загрузки
- Детальная диагностика чтения переменных окружения

## Что вы увидите

### Если проблема с .env файлом:
```
=== ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ ===
RUST_LOG=debug
=== КОНЕЦ ПЕРЕМЕННЫХ ===
```
(только RUST_LOG, нет ваших переменных)

### Если .env подхватывается:
```
=== ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ ===
BOT_TOKEN=test_token_for_diagnostics_123456
ALLOWED_USERS=123456789,987654321
SERVER_MAC=aa:bb:cc:dd:ee:ff
RUST_LOG=info
=== КОНЕЦ ПЕРЕМЕННЫХ ===
=== ЗАПУСК ПРИЛОЖЕНИЯ ===
=== СТАРТ ПРИЛОЖЕНИЯ ===
Rust приложение запущено успешно!
```

### Если проблема в коде:
Увидите на каком именно этапе падает приложение с детальными сообщениями.

## Команды для запуска диагностики

```bash
# Пересобрать контейнер с диагностикой
docker-compose build --no-cache

# Запустить с логами
docker-compose up

# Посмотреть логи контейнера
docker logs tg-server-manager

# Войти в контейнер для ручной диагностики
docker-compose run --rm telegram-bot /bin/bash
```

## Возможные проблемы и решения

### 1. .env файл не найден
- Убедитесь что .env файл в той же папке что docker-compose.yml
- Проверьте права доступа: `ls -la .env`

### 2. Проблемы с кодировкой .env
- Убедитесь что файл в UTF-8 без BOM
- Проверьте отсутствие лишних пробелов

### 3. Проблемы с переменными
- Заполните все обязательные переменные: BOT_TOKEN, ALLOWED_USERS, SERVER_MAC
- Проверьте формат ALLOWED_USERS (числа через запятую)

### 4. Проблемы с ключами SSH
- Проверьте что папка keys существует и содержит нужные файлы
- Убедитесь в правильных правах доступа к ключам

## Отключение диагностики

После выявления проблемы:
1. Удалите println! из main.rs  
2. Верните обычный CMD в Dockerfile:
   ```dockerfile
   CMD ["wakeonlan_bot"]
   ```
3. Удалите diagnostic_wrapper.sh