# Диагностика проблемы с запуском контейнера

## Внесенные улучшения для диагностики

Я добавил детальное логирование в код, чтобы точно понять где падает приложение:

### 1. Улучшенное логирование в `Config::from_env()`
- Теперь каждая переменная логируется при чтении
- Показывается точное содержимое `ALLOWED_USERS` 
- Логируется успешное завершение чтения конфига

### 2. Дополнительное логирование в `run()`
- Логируется каждый этап запуска
- Показывается когда создается бот и запускается обработчик

### 3. Улучшенный Dockerfile
- Проверка наличия SSH ключей при сборке
- Установлен `RUST_LOG=debug` по умолчанию

## Пошаговая диагностика

### Шаг 1: Пересоберите контейнер с новым кодом
```bash
docker-compose down
docker-compose build --no-cache
```

### Шаг 2: Запустите контейнер и сразу посмотрите логи
```bash
docker-compose up -d
docker logs -f tg-server-manager
```

### Ожидаемые логи при успешном запуске:
```
Запуск WakeOnLanBot...
Начинаю чтение конфигурации из переменных окружения...
BOT_TOKEN прочитан успешно
ALLOWED_USERS строка: '758356348,660172337'
ALLOWED_USERS распарсены: [758356348, 660172337]
SERVER_MAC прочитан: '00:9d:d8:aa:64:5a'
Все обязательные переменные прочитаны успешно
Конфигурация успешно загружена!
Экземпляр бота создан
Запускаем обработчик событий...
```

## Возможные проблемы и их диагностика

### Проблема 1: Ошибка "SERVER_MAC пуст"
**Возможная причина**: Проблема с форматом .env файла или кодировкой

**Решение**: 
```bash
# Проверьте что в .env есть SERVER_MAC без лишних пробелов
grep "SERVER_MAC" .env
```

### Проблема 2: Ошибка "BOT_TOKEN пуст"
**Возможная причина**: .env файл не передается в контейнер

**Диагностика**:
```bash
# Проверьте что .env файл существует
ls -la .env

# Проверьте права доступа
cat .env | head -5
```

### Проблема 3: Ошибка "ALLOWED_USERS пуст"
**Возможная причина**: Неправильный формат списка пользователей

**Проверка**: В логах должно быть видно что именно распарсилось в ALLOWED_USERS

### Проблема 4: SSH ключи не найдены
**Проверка при сборке**: Должна быть строка "=== Проверка SSH ключей ==="

### Проблема 5: Падение в handler.rs
**Диагностика**: Если видите "Запускаем обработчик событий..." но дальше ничего - проблема в teloxide

## Альтернативные способы запуска для диагностики

### Способ 1: Запуск без restart policy
Временно измените в docker-compose.yml:
```yaml
# restart: unless-stopped  # закомментируйте эту строку
```

### Способ 2: Интерактивный запуск
```bash
docker run -it --env-file .env -v $(pwd)/keys:/app/keys your-image-name /bin/bash
# Внутри контейнера запустите:
wakeonlan_bot
```

### Способ 3: Проверка переменных окружения
```bash
docker run --env-file .env your-image-name env | grep -E "(BOT_TOKEN|ALLOWED_USERS|SERVER_MAC)"
```

## Что делать дальше

1. Запустите обновленный контейнер
2. Посмотрите логи с подробным выводом
3. Определите на каком именно этапе падает приложение
4. Если проблема в переменных окружения - проверьте .env файл
5. Если проблема в SSH ключах - проверьте их наличие и права доступа
6. Если проблема в teloxide - возможно, проблема с сетью или токеном бота

Теперь у нас будет точная информация о том, что именно происходит при запуске!